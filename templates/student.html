<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Sinh viÃªn - Báº£ng Ä‘iá»u khiá»ƒn</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="container">
    <h2>ğŸ“ Xin chÃ o, <span id="studentName">Sinh viÃªn</span>!</h2>
    <p>Chá»n chá»©c nÄƒng bÃªn dÆ°á»›i:</p>

    <div class="menu">
      <a href="/attendance.html">ğŸ“¸ Äiá»ƒm danh</a>
      <a href="/enrollment.html">ğŸ§© ÄÄƒng kÃ½ lá»›p há»c pháº§n</a>
      <button onclick="viewRegisteredClasses()">ğŸ“š Lá»›p Ä‘Ã£ Ä‘Äƒng kÃ½</button>
      <button onclick="viewAttendanceHistory()">ğŸ•’ Lá»‹ch sá»­ Ä‘iá»ƒm danh</button>
    </div>

    <button style="margin-top: 2rem;" onclick="logout()">ğŸšª ÄÄƒng xuáº¥t</button>

    <div id="infoArea" style="margin-top: 2rem;"></div>
  </div>

  <script src="/static/script.js"></script>
  <script>
    let user_id, user_name, role;

    window.onload = function () {
      const currentUser = getCurrentUser();
      user_id = currentUser.user_id;
      user_name = currentUser.user_name;
      role = currentUser.role;

      if (!user_id || role !== "student") {
        alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p vá»›i tÆ° cÃ¡ch sinh viÃªn!");
        window.location.href = "/login.html";
        return;
      }

      if (user_name) {
        document.getElementById("studentName").textContent = user_name;
      }
    };

    async function viewRegisteredClasses() {
      const res = await fetch(`/get_student_classes?user_id=${user_id}`);
      const result = await res.json();
      const area = document.getElementById("infoArea");

      if (result.success) {
        if (result.data.length === 0) {
          area.innerHTML = "<p>Báº¡n chÆ°a Ä‘Äƒng kÃ½ lá»›p há»c pháº§n nÃ o.</p>";
        } else {
          const html = result.data.map(cls => `
            <div>
              <strong>${cls.class_id}</strong> - ${cls.class_name}
              <button onclick="unenrollClass('${cls.class_id}')">âŒ Huá»·</button>
            </div>
          `).join("");
          area.innerHTML = `<h3>ğŸ“š Lá»›p Ä‘Ã£ Ä‘Äƒng kÃ½:</h3>` + html;
        }
      } else {
        area.innerHTML = `<p style="color:red;">${result.message}</p>`;
      }
    }

    async function viewAttendanceHistory() {
      const classId = prompt("Nháº­p mÃ£ lá»›p há»c pháº§n Ä‘á»ƒ xem lá»‹ch sá»­ Ä‘iá»ƒm danh:");
      if (!classId) return;
      const res = await fetch(`/student_attendance_history?user_id=${user_id}&class_id=${classId}`);
      const result = await res.json();
      const area = document.getElementById("infoArea");

      if (result.success) {
        if (result.data.length === 0) {
          area.innerHTML = `<p>ChÆ°a cÃ³ lá»‹ch sá»­ Ä‘iá»ƒm danh trong lá»›p <strong>${classId}</strong>.</p>`;
        } else {
          const html = result.data.map(r => `<li>${r.timestamp} - ${r.status}</li>`).join("");
          area.innerHTML = `<h3>ğŸ•’ Lá»‹ch sá»­ Ä‘iá»ƒm danh lá»›p <strong>${classId}</strong>:</h3><ul>${html}</ul>`;
        }
      } else {
        area.innerHTML = `<p style="color:red;">${result.message}</p>`;
      }
    }

    async function unenrollClass(classId) {
      if (!confirm(`Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n huá»· Ä‘Äƒng kÃ½ lá»›p ${classId}?`)) return;

      const res = await fetch(`/unenroll_class?user_id=${user_id}&class_id=${classId}`, {
        method: "DELETE"
      });

      const result = await res.json();
      alert(result.message);
      if (result.success) viewRegisteredClasses();
    }
  </script>
</body>
</html>
